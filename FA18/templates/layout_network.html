<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>WikiInsights</title>
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
</head>

<body>

  <script type="text/javascript">
    var w = 2000;
    var h = 2000;
    var linkDistance = 500;
    var lineColor = "#938162"
    var textColor = "#000"
    var edgesToChangeBack = [];
    var nodesToChangeBack = [];
    var colors = d3.scale.category10();

    var dataset = {{network_json|tojson|safe}}
    //   {
    //   "nodes": [{
    //     "name": "Outline of physical science",
    //     "cluster": 3,
    //     "inlinks": 1
    //   }, {
    //     "name": "Metric (mathematics)",
    //     "cluster": 3,
    //     "inlinks": 1
    //   }, {
    //     "name": "Soliton",
    //     "cluster": 6,
    //     "inlinks": 1
    //   }, {
    //     "name": "Topology",
    //     "cluster": 0,
    //     "inlinks": 1
    //   }, {
    //     "name": "Higher-order function",
    //     "cluster": 7,
    //     "inlinks": 1
    //   }, {
    //     "name": "Orthonormal basis",
    //     "cluster": 4,
    //     "inlinks": 1
    //   }, {
    //     "name": "Row and column vectors",
    //     "cluster": 3,
    //     "inlinks": 1
    //   }, {
    //     "name": "Dynamical system",
    //     "cluster": 2,
    //     "inlinks": 1
    //   }, {
    //     "name": "Science",
    //     "cluster": 3,
    //     "inlinks": 1
    //   }, {
    //     "name": "Linearization",
    //     "cluster": 1,
    //     "inlinks": 2
    //   }, {
    //     "name": "Fourier series",
    //     "cluster": 6,
    //     "inlinks": 1
    //   }, {
    //     "name": "Function composition",
    //     "cluster": 2,
    //     "inlinks": 1
    //   }, {
    //     "name": "Nonlinear system",
    //     "cluster": 1,
    //     "inlinks": 3
    //   }, {
    //     "name": "Equation",
    //     "cluster": 1,
    //     "inlinks": 4
    //   }, {
    //     "name": "Functional analysis",
    //     "cluster": 8,
    //     "inlinks": 5
    //   }, {
    //     "name": "Origin (mathematics)",
    //     "cluster": 9,
    //     "inlinks": 1
    //   }, {
    //     "name": "Taylor series",
    //     "cluster": 8,
    //     "inlinks": 1
    //   }, {
    //     "name": "Three-dimensional space",
    //     "cluster": 7,
    //     "inlinks": 1
    //   }, {
    //     "name": "Geodesic",
    //     "cluster": 4,
    //     "inlinks": 1
    //   }, {
    //     "name": "Linear map",
    //     "cluster": 3,
    //     "inlinks": 1
    //   }, {
    //     "name": "Function space",
    //     "cluster": 1,
    //     "inlinks": 4
    //   }, {
    //     "name": "Partial differential equation",
    //     "cluster": 4,
    //     "inlinks": 2
    //   }, {
    //     "name": "Inner product space",
    //     "cluster": 0,
    //     "inlinks": 1
    //   }, {
    //     "name": "Integral equation",
    //     "cluster": 1,
    //     "inlinks": 1
    //   }, {
    //     "name": "Mathematics",
    //     "cluster": 3,
    //     "inlinks": 2
    //   }, {
    //     "name": "Dimension (vector space)",
    //     "cluster": 8,
    //     "inlinks": 2
    //   }, {
    //     "name": "Algebraic equation",
    //     "cluster": 1,
    //     "inlinks": 2
    //   }, {
    //     "name": "Calculus of variations",
    //     "cluster": 6,
    //     "inlinks": 4
    //   }, {
    //     "name": "Poland",
    //     "cluster": 2,
    //     "inlinks": 1
    //   }, {
    //     "name": "Scalar (mathematics)",
    //     "cluster": 6,
    //     "inlinks": 1
    //   }, {
    //     "name": "Euclidean vector",
    //     "cluster": 2,
    //     "inlinks": 2
    //   }, {
    //     "name": "Chaos theory",
    //     "cluster": 9,
    //     "inlinks": 1
    //   }, {
    //     "name": "Vector space",
    //     "cluster": 0,
    //     "inlinks": 2
    //   }, {
    //     "name": "Transformation matrix",
    //     "cluster": 0,
    //     "inlinks": 2
    //   }, {
    //     "name": "Integral",
    //     "cluster": 9,
    //     "inlinks": 1
    //   }, {
    //     "name": "Space (mathematics)",
    //     "cluster": 6,
    //     "inlinks": 3
    //   }, {
    //     "name": "Hilbert space",
    //     "cluster": 0,
    //     "inlinks": 3
    //   }, {
    //     "name": "Finite element method",
    //     "cluster": 7,
    //     "inlinks": 4
    //   }, {
    //     "name": "Map (mathematics)",
    //     "cluster": 8,
    //     "inlinks": 1
    //   }, {
    //     "name": "Norm (mathematics)",
    //     "cluster": 4,
    //     "inlinks": 6
    //   }, {
    //     "name": "Eigenvalues and eigenvectors",
    //     "cluster": 0,
    //     "inlinks": 2
    //   }, {
    //     "name": "Linear algebra",
    //     "cluster": 5,
    //     "inlinks": 0
    //   }, {
    //     "name": "Analytic geometry",
    //     "cluster": 4,
    //     "inlinks": 1
    //   }, {
    //     "name": "Morphism",
    //     "cluster": 0,
    //     "inlinks": 1
    //   }, {
    //     "name": "Functional (mathematics)",
    //     "cluster": 6,
    //     "inlinks": 1
    //   }, {
    //     "name": "Giuseppe Peano",
    //     "cluster": 2,
    //     "inlinks": 1
    //   }, {
    //     "name": "Mathematical analysis",
    //     "cluster": 5,
    //     "inlinks": 6
    //   }, {
    //     "name": "Banach space",
    //     "cluster": 1,
    //     "inlinks": 2
    //   }, {
    //     "name": "Stefan Banach",
    //     "cluster": 0,
    //     "inlinks": 1
    //   }],
    //   "edges": [{
    //     "id": 0,
    //     "source": 41,
    //     "target": 39,
    //     "iters": 2
    //   }, {
    //     "id": 1,
    //     "source": 39,
    //     "target": 20,
    //     "iters": 2
    //   }, {
    //     "id": 2,
    //     "source": 20,
    //     "target": 25,
    //     "iters": 1
    //   }, {
    //     "id": 3,
    //     "source": 25,
    //     "target": 35,
    //     "iters": 1
    //   }, {
    //     "id": 4,
    //     "source": 35,
    //     "target": 14,
    //     "iters": 2
    //   }, {
    //     "id": 5,
    //     "source": 14,
    //     "target": 5,
    //     "iters": 1
    //   }, {
    //     "id": 6,
    //     "source": 5,
    //     "target": 47,
    //     "iters": 1
    //   }, {
    //     "id": 7,
    //     "source": 47,
    //     "target": 43,
    //     "iters": 1
    //   }, {
    //     "id": 8,
    //     "source": 43,
    //     "target": 20,
    //     "iters": 1
    //   }, {
    //     "id": 9,
    //     "source": 41,
    //     "target": 9,
    //     "iters": 2
    //   }, {
    //     "id": 10,
    //     "source": 9,
    //     "target": 12,
    //     "iters": 1
    //   }, {
    //     "id": 11,
    //     "source": 12,
    //     "target": 40,
    //     "iters": 1
    //   }, {
    //     "id": 12,
    //     "source": 40,
    //     "target": 30,
    //     "iters": 1
    //   }, {
    //     "id": 13,
    //     "source": 30,
    //     "target": 39,
    //     "iters": 1
    //   }, {
    //     "id": 14,
    //     "source": 39,
    //     "target": 47,
    //     "iters": 1
    //   }, {
    //     "id": 15,
    //     "source": 47,
    //     "target": 35,
    //     "iters": 1
    //   }, {
    //     "id": 16,
    //     "source": 14,
    //     "target": 3,
    //     "iters": 1
    //   }, {
    //     "id": 17,
    //     "source": 41,
    //     "target": 14,
    //     "iters": 1
    //   }, {
    //     "id": 18,
    //     "source": 14,
    //     "target": 36,
    //     "iters": 1
    //   }, {
    //     "id": 19,
    //     "source": 36,
    //     "target": 46,
    //     "iters": 2
    //   }, {
    //     "id": 20,
    //     "source": 46,
    //     "target": 46,
    //     "iters": 1
    //   }, {
    //     "id": 21,
    //     "source": 46,
    //     "target": 34,
    //     "iters": 1
    //   }, {
    //     "id": 22,
    //     "source": 34,
    //     "target": 46,
    //     "iters": 1
    //   }, {
    //     "id": 23,
    //     "source": 46,
    //     "target": 10,
    //     "iters": 1
    //   }, {
    //     "id": 24,
    //     "source": 10,
    //     "target": 46,
    //     "iters": 1
    //   }, {
    //     "id": 25,
    //     "source": 46,
    //     "target": 37,
    //     "iters": 1
    //   }, {
    //     "id": 26,
    //     "source": 41,
    //     "target": 22,
    //     "iters": 1
    //   }, {
    //     "id": 27,
    //     "source": 22,
    //     "target": 35,
    //     "iters": 1
    //   }, {
    //     "id": 28,
    //     "source": 35,
    //     "target": 39,
    //     "iters": 1
    //   }, {
    //     "id": 29,
    //     "source": 39,
    //     "target": 14,
    //     "iters": 1
    //   }, {
    //     "id": 30,
    //     "source": 14,
    //     "target": 44,
    //     "iters": 1
    //   }, {
    //     "id": 31,
    //     "source": 44,
    //     "target": 13,
    //     "iters": 1
    //   }, {
    //     "id": 32,
    //     "source": 13,
    //     "target": 37,
    //     "iters": 2
    //   }, {
    //     "id": 33,
    //     "source": 37,
    //     "target": 37,
    //     "iters": 1
    //   }, {
    //     "id": 34,
    //     "source": 37,
    //     "target": 21,
    //     "iters": 2
    //   }, {
    //     "id": 35,
    //     "source": 41,
    //     "target": 25,
    //     "iters": 1
    //   }, {
    //     "id": 36,
    //     "source": 25,
    //     "target": 30,
    //     "iters": 1
    //   }, {
    //     "id": 37,
    //     "source": 30,
    //     "target": 6,
    //     "iters": 1
    //   }, {
    //     "id": 38,
    //     "source": 6,
    //     "target": 33,
    //     "iters": 1
    //   }, {
    //     "id": 39,
    //     "source": 33,
    //     "target": 33,
    //     "iters": 1
    //   }, {
    //     "id": 40,
    //     "source": 33,
    //     "target": 40,
    //     "iters": 1
    //   }, {
    //     "id": 41,
    //     "source": 40,
    //     "target": 12,
    //     "iters": 1
    //   }, {
    //     "id": 42,
    //     "source": 12,
    //     "target": 2,
    //     "iters": 1
    //   }, {
    //     "id": 43,
    //     "source": 2,
    //     "target": 13,
    //     "iters": 1
    //   }, {
    //     "id": 44,
    //     "source": 41,
    //     "target": 20,
    //     "iters": 1
    //   }, {
    //     "id": 45,
    //     "source": 20,
    //     "target": 39,
    //     "iters": 1
    //   }, {
    //     "id": 46,
    //     "source": 39,
    //     "target": 36,
    //     "iters": 1
    //   }, {
    //     "id": 47,
    //     "source": 36,
    //     "target": 27,
    //     "iters": 1
    //   }, {
    //     "id": 48,
    //     "source": 27,
    //     "target": 13,
    //     "iters": 1
    //   }, {
    //     "id": 49,
    //     "source": 21,
    //     "target": 26,
    //     "iters": 1
    //   }, {
    //     "id": 50,
    //     "source": 26,
    //     "target": 13,
    //     "iters": 1
    //   }, {
    //     "id": 51,
    //     "source": 41,
    //     "target": 17,
    //     "iters": 1
    //   }, {
    //     "id": 52,
    //     "source": 17,
    //     "target": 15,
    //     "iters": 1
    //   }, {
    //     "id": 53,
    //     "source": 15,
    //     "target": 42,
    //     "iters": 1
    //   }, {
    //     "id": 54,
    //     "source": 42,
    //     "target": 18,
    //     "iters": 1
    //   }, {
    //     "id": 55,
    //     "source": 18,
    //     "target": 27,
    //     "iters": 1
    //   }, {
    //     "id": 56,
    //     "source": 27,
    //     "target": 11,
    //     "iters": 1
    //   }, {
    //     "id": 57,
    //     "source": 11,
    //     "target": 27,
    //     "iters": 1
    //   }, {
    //     "id": 58,
    //     "source": 27,
    //     "target": 46,
    //     "iters": 1
    //   }, {
    //     "id": 59,
    //     "source": 46,
    //     "target": 16,
    //     "iters": 1
    //   }, {
    //     "id": 60,
    //     "source": 9,
    //     "target": 31,
    //     "iters": 1
    //   }, {
    //     "id": 61,
    //     "source": 31,
    //     "target": 24,
    //     "iters": 1
    //   }, {
    //     "id": 62,
    //     "source": 24,
    //     "target": 48,
    //     "iters": 1
    //   }, {
    //     "id": 63,
    //     "source": 48,
    //     "target": 45,
    //     "iters": 1
    //   }, {
    //     "id": 64,
    //     "source": 45,
    //     "target": 28,
    //     "iters": 1
    //   }, {
    //     "id": 65,
    //     "source": 28,
    //     "target": 8,
    //     "iters": 1
    //   }, {
    //     "id": 66,
    //     "source": 8,
    //     "target": 0,
    //     "iters": 1
    //   }, {
    //     "id": 67,
    //     "source": 0,
    //     "target": 24,
    //     "iters": 1
    //   }, {
    //     "id": 68,
    //     "source": 41,
    //     "target": 36,
    //     "iters": 1
    //   }, {
    //     "id": 69,
    //     "source": 46,
    //     "target": 23,
    //     "iters": 1
    //   }, {
    //     "id": 70,
    //     "source": 23,
    //     "target": 26,
    //     "iters": 1
    //   }, {
    //     "id": 71,
    //     "source": 26,
    //     "target": 12,
    //     "iters": 1
    //   }, {
    //     "id": 72,
    //     "source": 12,
    //     "target": 7,
    //     "iters": 1
    //   }, {
    //     "id": 73,
    //     "source": 7,
    //     "target": 32,
    //     "iters": 1
    //   }, {
    //     "id": 74,
    //     "source": 32,
    //     "target": 29,
    //     "iters": 1
    //   }, {
    //     "id": 75,
    //     "source": 29,
    //     "target": 39,
    //     "iters": 1
    //   }, {
    //     "id": 76,
    //     "source": 20,
    //     "target": 1,
    //     "iters": 1
    //   }, {
    //     "id": 77,
    //     "source": 1,
    //     "target": 32,
    //     "iters": 1
    //   }, {
    //     "id": 78,
    //     "source": 32,
    //     "target": 14,
    //     "iters": 1
    //   }, {
    //     "id": 79,
    //     "source": 14,
    //     "target": 19,
    //     "iters": 1
    //   }, {
    //     "id": 80,
    //     "source": 19,
    //     "target": 38,
    //     "iters": 1
    //   }, {
    //     "id": 81,
    //     "source": 38,
    //     "target": 4,
    //     "iters": 1
    //   }, {
    //     "id": 82,
    //     "source": 4,
    //     "target": 27,
    //     "iters": 1
    //   }]
    // };
    // nodes: [{
    //     name: "Adam",
    //     cluster: 0,
    //     inlinks: 0
    //   },
    //   {
    //     name: "Bob",
    //     cluster: 3,
    //     inlinks: 4
    //   },
    //   {
    //     name: "Carrie",
    //     cluster: 4,
    //     inlinks: 2
    //   },
    //   {
    //     name: "Donovan",
    //     cluster: 4,
    //     inlinks: 5
    //   },
    //   {
    //     name: "Edward",
    //     cluster: 2,
    //     inlinks: 3
    //   },
    //   {
    //     name: "Felicity",
    //     cluster: 3,
    //     inlinks: 7
    //   },
    //   {
    //     name: "George",
    //     cluster: 3,
    //     inlinks: 0
    //   },
    //   {
    //     name: "Hannah",
    //     cluster: 2,
    //     inlinks: 1
    //   },
    //   {
    //     name: "Iris",
    //     cluster: 3,
    //     inlinks: 5
    //   },
    //   {
    //     name: "Jerry",
    //     cluster: 4,
    //     inlinks: 5
    //   }
    // ],
    // edges: [{
    //     id: 0,
    //     source: 0,
    //     target: 1,
    //     iters: 4
    //   },
    //   {
    //     id: 1,
    //     source: 0,
    //     target: 2,
    //     iters: 2
    //   },
    //   {
    //     id: 2,
    //     source: 0,
    //     target: 3,
    //     iters: 5
    //   },
    //   {
    //     id: 3,
    //     source: 0,
    //     target: 4,
    //     iters: 2
    //   },
    //   {
    //     id: 4,
    //     source: 1,
    //     target: 5,
    //     iters: 6
    //   },
    //   {
    //     id: 5,
    //     source: 2,
    //     target: 5,
    //     iters: 1
    //   },
    //   {
    //     id: 6,
    //     source: 3,
    //     target: 4,
    //     iters: 1
    //   },
    //   {
    //     id: 7,
    //     source: 5,
    //     target: 8,
    //     iters: 3
    //   },
    //   {
    //     id: 8,
    //     source: 5,
    //     target: 9,
    //     iters: 2
    //   },
    //   {
    //     id: 9,
    //     source: 6,
    //     target: 7,
    //     iters: 1
    //   },
    //   {
    //     id: 10,
    //     source: 7,
    //     target: 8,
    //     iters: 2
    //   },
    //   {
    //     id: 11,
    //     source: 8,
    //     target: 9,
    //     iters: 3
    //   }
    // ]

    var svg = d3.select("body").append("svg").attr({
      "width": w,
      "height": h
    });

    var force = d3.layout.force()
      .nodes(dataset.nodes)
      .links(dataset.edges)
      .size([w, h])
      .linkDistance([linkDistance])
      .charge([-500])
      .theta(0.1)
      .gravity(0.05)
      .start();

    var edges = svg.selectAll("line")
      .data(dataset.edges)
      .enter()
      .append("line")
      .attr("id", function(d, i) {
        return 'edge' + i
      })
      .attr('marker-end', function(d) {
        return 'url(#arrowhead_' + d.id + ')'
      })
      .style("stroke", lineColor)
      .style("stroke-width", function(d) {
        return Math.pow(d.iters, 1.8);
      })
      .style("pointer-events", "none");

    var nodes = svg.selectAll("circle")
      .data(dataset.nodes)
      .enter()
      .append("circle")
      .attr("id", function(d) {
        return 'node' + d
      })
      .attr("r", function(d) {
        return d.inlinks * 2 + 8;
      })
      .style("fill", function(d) {
        return colors(d.cluster);
      })
      .style("stroke", "#fff")
      .style("stroke-width", "4")
      .call(force.drag)
      .on("mouseover", function(d) {
        highlightGraphNode(d, true, this);
      })
      .on("mouseout", function(d) {
        highlightGraphNode(d, false, this);
      })
      .on("dblclick", function(d) {
        window.open('https://en.wikipedia.org/wiki/' + d.name.replace(" ","_"));
      });

    function highlightGraphNode(node, on) {
      if (on) {
        nodeOI = nodes[0][node['index']];
        nodeOI.style.fill= '#000';
        nodeOI.style.stroke= 'red';
        var i;
        for (i=0; i<83; i++) {
          var edgeOI = edges[0][i];
          if (edgeOI['__data__']['source']['index'] == node['index']) {
            targetNodeOI = nodes[0][edgeOI['__data__']['target']['index']];
            targetNodeOI.style.fill= '#000';
            targetNodeOI.style.stroke= 'red';
            edgeOI.style.stroke= 'red';
            arrowMarkers[0][i].style.fill= 'red';
            nodesToChangeBack.push(targetNodeOI);
            edgesToChangeBack.push(i);
          }
        }
      } else {
        nodes[0][node['index']].style.fill= colors(node['cluster']);
        nodes[0][node['index']].style.stroke= '#fff';
        var i;
        for (i=0; i<nodesToChangeBack.length; i++) {
          nodesToChangeBack[i].style.fill= colors(nodesToChangeBack[i]['__data__']['cluster']);
          nodesToChangeBack[i].style.stroke= '#fff';
        }
        for (i=0; i<edgesToChangeBack.length; i++) {
          edges[0][edgesToChangeBack[i]].style.stroke= lineColor;
          arrowMarkers[0][edgesToChangeBack[i]].style.fill= lineColor;
        }
      }
    }

    var nodelabels = svg.selectAll(".nodelabel")
      .data(dataset.nodes)
      .enter()
      .append("text")
      .attr({
        "x": function(d) {
          return d.x;
        },
        "y": function(d) {
          return d.y;
        },
        "class": "nodelabel",
        "stroke": textColor,
        "fill": textColor
      })
      .text(function(d) {
        return d.name;
      })
      .style('font-family', 'sans-serif');

    var edgepaths = svg.selectAll(".edgepath")
      .append('path');

    var edgelabels = svg.selectAll(".edgelabel")
      .append('text');

    var arrowMarkers = svg.selectAll('defs')
      .data(dataset.edges)
      .enter()
      .append('marker')
      .attr({
        'viewBox': '-0 -5 10 10',
        'markerWidth': 5,
        'markerHeight': 5,
        'refY': 0,
        'orient': 'auto',
        'xoverflow': 'visible'
      })
      .attr('id', function(d) {
        return 'arrowhead_' + d.id;
      })
      .attr('refX', function(d) {
        return (160 / Math.pow(d.iters, .8));
      })
      // function(d) {
      //   switch (d.iters) {
      //     case 1:
      //       refx = 43;
      //       break;
      //     case 2:
      //       refx = 25.5;
      //       break;
      //     case 3:
      //       refx = 20;
      //       break;
      //     case 4:
      //       refx = 17;
      //       break;
      //     case 5:
      //       refx = 15;
      //       break;
      //     default:
      //       refx = 14;
      //       break;
      //   }
      //   return refx;
      // })
      .append('svg:path')
      .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
      .attr('fill', lineColor)
      .attr('stroke', lineColor)
      .attr('stroke-width', 0);

    force.on("tick", function() {
      edges.attr({
        "x1": function(d) {
          return d.source.x;
        },
        "y1": function(d) {
          return d.source.y;
        },
        "x2": function(d) {
          return d.target.x;
        },
        "y2": function(d) {
          return d.target.y;
        }
      });

      nodes.attr({
        "cx": function(d) {
          return d.x;
        },
        "cy": function(d) {
          return d.y;
        }
      })

      nodelabels.attr("x", function(d) {
          return d.x + 20;
        })
        .attr("y", function(d) {
          return d.y;
        });

      // arrowMarkers.attr("refX", function(d) {
      //   var e = document.getElementById("edge" + d.id);
      //   var a = (Math.pow(
      //     Math.pow(e.x2['baseVal']['value'] - e.x1['baseVal']['value'], 2) +
      //     Math.pow(e.y2['baseVal']['value'] - e.y1['baseVal']['value'], 2), 0.5) / 2);
      //   console.log(a);
      //   return a;
      // })
    });
  </script>
</body>

</html>
